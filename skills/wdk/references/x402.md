# x402 — HTTP-Native USD₮ Payments

## Navigation

| Goal | Go to |
|------|-------|
| **Pay for a resource / make x402 requests** | [Role 1: Client (Buyer)](#role-1-client-buyer) |
| **Accept payments on a server — delegate settlement to a third party** | [Role 2: Server — Hosted Facilitator](#role-2-server--hosted-facilitator) |
| **Accept payments on a server — self-sovereign, any USD₮0 chain, no external deps** | [Role 3: Server — Self-Hosted Facilitator](#role-3-server--self-hosted-facilitator-in-process) |
| **Wallet doesn't have USD₮0 yet** | [Getting USD₮0 (Bridge from Ethereum)](#getting-usd0-bridge-from-ethereum) |

---

## Links

| Resource | URL |
|----------|-----|
| **x402 Protocol Spec** | https://www.x402.org |
| **x402 GitHub** | https://github.com/coinbase/x402 |
| **WDK x402 Docs** | https://docs.wallet.tether.io/x402 |
| **Demo Repo** | https://github.com/SemanticPay/x402-usdt0-demo |
| **Semantic Facilitator Docs** | https://docs.semanticpay.io |
| **Self-Hosted Facilitator (npm)** | https://www.npmjs.com/package/@semanticio/wdk-wallet-evm-x402-facilitator |
| **USD₮0 Deployments** | https://docs.usdt0.to/technical-documentation/deployments |

## What Is x402?

x402 gives the HTTP 402 Payment Required status code a concrete blockchain-native meaning: if you want this resource, pay for it. No accounts, API keys, or checkout flows. Payment is a first-class part of the request-response cycle — discover price → sign → receive resource.

### Three Roles

| Role | Description |
|------|-------------|
| **Client (Buyer)** | Requests paid resources. Holds a WDK wallet with USD₮0. |
| **Resource Server (Seller)** | Returns `402` for unpaid requests with payment requirements in the body. Calls facilitator to verify + settle. |
| **Facilitator** | Verifies payment signatures and submits settlement on-chain. Never holds funds. |

### How It Works

1. Client sends a normal HTTP request
2. Server responds `402` with payment details (amount, token, network, recipient)
3. Client signs an **EIP-3009** `transferWithAuthorization` — no tokens move yet
4. Client retries with the signed payload in the `X-PAYMENT` header
5. Server calls facilitator `/verify` — checks signature, amount, balance
6. Server performs the work
7. Facilitator settles on-chain — transfers USD₮0 from buyer to seller
8. Server returns `200 OK` with result + `X-PAYMENT-RESPONSE` receipt header

### Recommended Chains

Prefer **Plasma** and **Stable** — purpose-built for USD₮ with near-instant finality and near-zero fees.

| Chain | CAIP-2 | RPC | USD₮0 Contract |
|-------|--------|-----|----------------|
| **Plasma** | `eip155:9745` | `https://rpc.plasma.to` | `0xB8CE59FC3717ada4C02eaDF9682A9e934F625ebb` |
| **Stable** | `eip155:988` | `https://rpc.stable.xyz` | `0x779Ded0c9e1022225f8E0630b35a9b54bE713736` |

---

## Role 1: Client (Buyer)

Pay for x402-protected resources using a WDK wallet. `WalletAccountEvm` satisfies the `ClientEvmSigner` interface directly — no adapter needed.

```bash
npm install @tetherto/wdk-wallet-evm @x402/fetch @x402/evm
```

```javascript
import WalletManagerEvm from "@tetherto/wdk-wallet-evm";
import { x402Client, wrapFetchWithPayment } from "@x402/fetch";
import { registerExactEvmScheme } from "@x402/evm/exact/client";

// 1. Create wallet
const account = await new WalletManagerEvm(process.env.SEED_PHRASE, {
  provider: "https://rpc.plasma.to",  // or "https://rpc.stable.xyz"
}).getAccount();

// 2. Register with x402 — WalletAccountEvm satisfies ClientEvmSigner directly
const client = new x402Client();
registerExactEvmScheme(client, { signer: account });
const fetchWithPayment = wrapFetchWithPayment(fetch, client);

// 3. Make a paid request — 402 interception, signing, and retry are automatic
const response = await fetchWithPayment("https://api.example.com/weather");
const data = await response.json();
```

### Getting USD₮0 (Bridge from Ethereum)

If the wallet doesn't yet have USD₮0 on Plasma/Stable, bridge it first using `wdk-protocol-bridge-usdt0-evm`.

```bash
npm install @tetherto/wdk-wallet-evm @tetherto/wdk-protocol-bridge-usdt0-evm
```

```javascript
import WalletManagerEvm from "@tetherto/wdk-wallet-evm";
import Usdt0ProtocolEvm from "@tetherto/wdk-protocol-bridge-usdt0-evm";

const account = await new WalletManagerEvm(process.env.SEED_PHRASE, {
  provider: "https://eth.drpc.org",  // Source chain RPC
}).getAccount();

const bridge = new Usdt0ProtocolEvm(account, {
  bridgeMaxFee: 100000000000000n,  // Max 0.0001 ETH in bridge fees
});

const USDT_ETHEREUM = "0xdAC17F958D2ee523a2206206994597C13D831ec7";

// Quote first (always)
const quote = await bridge.quoteBridge({
  targetChain: "plasma",  // or "stable"
  recipient: await account.getAddress(),
  token: USDT_ETHEREUM,
  amount: 10000000n,  // 10 USD₮ (6 decimals)
});
console.log("Bridge cost:", Number(quote.fee + quote.bridgeFee) / 1e18, "ETH");

// Execute (requires human confirmation — real funds)
const result = await bridge.bridge({
  targetChain: "plasma",
  recipient: await account.getAddress(),
  token: USDT_ETHEREUM,
  amount: 10000000n,
});
console.log("Bridge tx:", result.hash);
// USD₮0 arrives on Plasma within a few minutes
```

---

## Role 2: Server — Hosted Facilitator

Accept x402 payments by delegating verification and settlement to the Semantic hosted facilitator at `https://x402.semanticpay.io`. No direct chain interaction required.

> ⚠️ Semantic is a third-party service not operated or endorsed by Tether. Supports Plasma and Stable only.

```bash
npm install @tetherto/wdk-wallet-evm @x402/express @x402/evm @x402/core express dotenv
```

```javascript
import WalletManagerEvm from "@tetherto/wdk-wallet-evm";
import { HTTPFacilitatorClient } from "@x402/core/server";
import { paymentMiddleware, x402ResourceServer } from "@x402/express";
import { ExactEvmScheme } from "@x402/evm/exact/server";
import express from "express";

const PLASMA_NETWORK = "eip155:9745";
const USDT0_PLASMA   = "0xB8CE59FC3717ada4C02eaDF9682A9e934F625ebb";
// Stable: network = "eip155:988", usdt0 = "0x779Ded0c9e1022225f8E0630b35a9b54bE713736"

// 1. Derive receiving address
const account = await new WalletManagerEvm(process.env.SEED_PHRASE, {
  provider: "https://rpc.plasma.to",
}).getAccount();
const sellerAddress = await account.getAddress();

// 2. Hosted facilitator client
const facilitatorClient = new HTTPFacilitatorClient({
  url: "https://x402.semanticpay.io/",
});

// 3. Resource server + payment middleware
const resourceServer = new x402ResourceServer(facilitatorClient)
  .register(PLASMA_NETWORK, new ExactEvmScheme());

const app = express();

app.use(
  paymentMiddleware(
    {
      "GET /weather": {
        accepts: [{
          scheme: "exact",
          network: PLASMA_NETWORK,
          price: {
            amount: "1000",         // $0.001 (6 decimals)
            asset: USDT0_PLASMA,
            extra: { name: "USDT0", version: "1", decimals: 6 },
          },
          payTo: sellerAddress,
        }],
        description: "Weather data",
        mimeType: "application/json",
      },
    },
    resourceServer,
  ),
);

// Gated route — requires payment
app.get("/weather", (req, res) => {
  res.json({ weather: "sunny", temperature: 70 });
});

// Ungated route — no payment config, behaves normally
app.get("/health", (req, res) => res.json({ status: "ok" }));

app.listen(4021);
```

### Multi-Chain (Plasma + Stable)

Register both networks — the buyer's client picks whichever it has funds on.

```javascript
const NETWORKS = {
  plasma: { network: "eip155:9745", usdt0: "0xB8CE59FC3717ada4C02eaDF9682A9e934F625ebb" },
  stable: { network: "eip155:988",  usdt0: "0x779Ded0c9e1022225f8E0630b35a9b54bE713736" },
};

const resourceServer = new x402ResourceServer(facilitatorClient)
  .register(NETWORKS.plasma.network, new ExactEvmScheme())
  .register(NETWORKS.stable.network, new ExactEvmScheme());

// In paymentMiddleware:
// accepts: [
//   { scheme: "exact", network: NETWORKS.plasma.network, price: { amount, asset: NETWORKS.plasma.usdt0, extra }, payTo },
//   { scheme: "exact", network: NETWORKS.stable.network, price: { amount, asset: NETWORKS.stable.usdt0, extra }, payTo },
// ]
```

### Lifecycle Event Callbacks (Optional)

Receive real-time settlement events via `X-Event-Callback`:

| Event | When |
|-------|------|
| `verify_started` | Facilitator begins verifying |
| `verify_completed` | Verification finished (`details.isValid`) |
| `verify_failed` | Verification error (`details.error`) |
| `settle_started` | Broadcasting on-chain |
| `settle_completed` | Confirmed (`details.transactionHash`) |
| `settle_failed` | Settlement error (`details.error`) |

```javascript
const facilitatorClient = new HTTPFacilitatorClient({
  url: "https://x402.semanticpay.io/",
  fetch: (url, init) =>
    fetch(url, {
      ...init,
      headers: { ...init?.headers, "X-Event-Callback": "https://yourserver.com/payment-events" },
    }),
});
```

Events are fire-and-forget — silently dropped if the callback URL is unreachable.

---

## Role 3: Server — Self-Hosted Facilitator (In-Process)

Run verification and settlement locally using `@semanticio/wdk-wallet-evm-x402-facilitator`. Works on **any EVM chain with USD₮0** (not just Plasma/Stable). No external dependencies.

> ⚠️ Community module by Semantic Pay. Currently in beta. Not audited or endorsed by Tether.

```bash
npm install @semanticio/wdk-wallet-evm-x402-facilitator @tetherto/wdk-wallet-evm @x402/core @x402/evm @x402/express express dotenv
```

```javascript
import WalletManagerEvm from "@tetherto/wdk-wallet-evm";
import WalletAccountEvmX402Facilitator from "@semanticio/wdk-wallet-evm-x402-facilitator";
import { x402Facilitator } from "@x402/core/facilitator";
import { registerExactEvmScheme } from "@x402/evm/exact/facilitator";
import { paymentMiddleware, x402ResourceServer } from "@x402/express";
import { ExactEvmScheme } from "@x402/evm/exact/server";
import express from "express";

const NETWORK = process.env.NETWORK_ID  || "eip155:9745";
const USDT0   = process.env.USDT0_ADDRESS || "0xB8CE59FC3717ada4C02eaDF9682A9e934F625ebb";

// 1. Facilitator wallet — pays gas for settlement txs (can differ from seller wallet)
const walletAccount = await new WalletManagerEvm(process.env.FACILITATOR_MNEMONIC, {
  provider: process.env.RPC_URL,
}).getAccount();
const evmSigner = new WalletAccountEvmX402Facilitator(walletAccount);

// 2. In-process facilitator with hooks
const facilitator = new x402Facilitator()
  .onAfterVerify(async (ctx) => {
    console.log("[verify]", ctx.result?.isValid ? "valid" : "invalid");
  })
  .onAfterSettle(async (ctx) => {
    console.log("[settle] tx:", ctx.result?.transaction);
  });

registerExactEvmScheme(facilitator, {
  signer: evmSigner,
  networks: NETWORK,
});

// 3. Wire into Express — same pattern as hosted, just pass facilitator directly
const resourceServer = new x402ResourceServer(facilitator)
  .register(NETWORK, new ExactEvmScheme());

const app = express();

app.use(
  paymentMiddleware(
    {
      "GET /weather": {
        accepts: [{
          scheme: "exact",
          network: NETWORK,
          price: { amount: "1000", asset: USDT0, extra: { name: "USDT0", version: "1", decimals: 6 } },
          payTo: process.env.PAY_TO_ADDRESS,
        }],
        description: "Weather data",
        mimeType: "application/json",
      },
    },
    resourceServer,
  ),
);

app.get("/weather", (req, res) => res.json({ weather: "sunny", temperature: 70 }));
app.listen(4021);
```

Available hooks: `onBeforeVerify`, `onAfterVerify`, `onBeforeSettle`, `onAfterSettle` — all async, receive context with payment payload and result.

---

## Summary

| Role | Packages | Notes |
|------|----------|-------|
| **Buyer** | `@tetherto/wdk-wallet-evm`, `@x402/fetch`, `@x402/evm` | `WalletAccountEvm` satisfies `ClientEvmSigner` directly |
| **Seller (Hosted)** | `@tetherto/wdk-wallet-evm`, `@x402/express`, `@x402/evm`, `@x402/core` | Delegates to Semantic facilitator. Plasma + Stable only. |
| **Seller (Self-Hosted)** | `@tetherto/wdk-wallet-evm`, `@semanticio/wdk-wallet-evm-x402-facilitator`, `@x402/core`, `@x402/evm`, `@x402/express` | In-process. Any USD₮0 chain. |

## Security Notes

- ⚠️ `WalletAccountEvm` used as a buyer signs EIP-3009 authorizations — treat like a `sendTransaction`. Always confirm with user before making paid requests.
- The facilitator wallet (`FACILITATOR_MNEMONIC`) needs native tokens for gas. Keep it funded but separate from the seller wallet.
- Never log or expose `SEED_PHRASE` or `FACILITATOR_MNEMONIC`.